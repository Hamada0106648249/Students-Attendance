<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>QR Attendance — DEBUG Minimal (No Firebase, No CDN)</title>
<style>
  :root { --bg:#0b1020; --card:#121a2c; --muted:#9fb3c8; --ok:#19c37d; --bad:#ff5454; }
  html,body{margin:0;padding:0;background:var(--bg);color:#fff;font-family:system-ui,Segoe UI,Arial,"Noto Kufi Arabic",sans-serif}
  .wrap{max-width:880px;margin:0 auto;padding:24px}
  .card{background:var(--card);border-radius:14px;border:1px solid #243356;padding:16px}
  button{padding:10px 14px;border-radius:10px;border:0;background:#0a6ad6;color:#fff;cursor:pointer}
  input{width:100%;padding:10px;border-radius:10px;border:1px solid #25406b;background:#0c1426;color:#fff}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .qrBox{display:grid;place-items:center;min-height:280px;border:2px dashed #3b5891;border-radius:14px}
  .muted{color:var(--muted);font-size:13px}
  pre.diag{white-space:pre-wrap;background:#0e172b;border-radius:10px;padding:10px;border:1px solid #1f2d4b}
</style>
</head>
<body>
<div class="wrap">
  <h1>اختبار عرض QR — إصدار تشخيصي مبسّط (بدون Firebase)</h1>
  <p class="muted">هذا ملف مستقل تمامًا لا يعتمد على أي شبكة. إذا ظهر QR هنا فالمشكلة ليست في المكتبة، بل في الإعدادات/الأذونات في الصفحة السابقة أو في Firebase. إذا لم يظهر QR هنا أيضًا، فغالبًا يوجد تعارض سياسة أمان (CSP) يمنع تشغيل السكربتات.</p>

  <div class="card">
    <div class="row">
      <div>
        <label>فاصل التحديث (ثانية)</label>
        <input id="interval" type="number" min="3" step="1" value="10" />
        <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
          <button id="btnTest">رسم QR تجريبي الآن</button>
          <button id="btnStart">ابدأ التدوير</button>
          <button id="btnStop" style="background:#7a1f1f">إيقاف</button>
        </div>
        <div class="muted" style="margin-top:8px">سيظهر رابط الطلبة الحالي أسفل QR.</div>
      </div>
      <div>
        <div class="qrBox"><div id="qr"></div></div>
        <div id="link" class="muted" style="margin-top:8px;word-break:break-all"></div>
      </div>
    </div>
  </div>

  <div style="margin-top:16px" class="card">
    <h3 style="margin-top:0">السجل التشخيصي</h3>
    <pre id="diag" class="diag"></pre>
  </div>

  <div class="card" style="margin-top:16px">
    <h3 style="margin-top:0">ملاحظات مهمة</h3>
    <ul>
      <li>هذا الملف لا يستخدم أي شبكة مطلقًا؛ إذا فشل عرض QR هنا، فسبب ذلك يكون غالبًا سياسة <b>CSP</b> تمنع السكربتات المضمّنة. الحل: اجعل السكربت في ملف خارجي وأضف <code>nonce</code> أو <code>sha256</code> في <code>Content-Security-Policy</code>.</li>
      <li>بعد نجاح العرض هنا، سنعيد دمج نفس محرك QR مع صفحة الحضور وربط Firebase تدريجيًا.</li>
    </ul>
  </div>
</div>

<script>
/* === Offline QR: compact inline encoder (minimal canvas renderer) === */
(function(){
  function QR8bitByte(data){this.mode=4;this.data=data}
  QR8bitByte.prototype.getLength=function(){return this.data.length};
  QR8bitByte.prototype.write=function(buffer){for(var i=0;i<this.data.length;i++){var code=this.data.charCodeAt(i);if(code<128)buffer.put(code,8);else if(code<2048){buffer.put(192|(code>>6),8);buffer.put(128|(63&code),8)}else{buffer.put(224|(code>>12),8);buffer.put(128|((code>>6)&63),8);buffer.put(128|(63&code),8)}}};
  function BitBuffer(){this.buffer=[];this.length=0}
  BitBuffer.prototype.put=function(num,length){for(var i=0;i<length;i++)this.putBit(((num>>>(length-i-1))&1)==1)};
  BitBuffer.prototype.putBit=function(bit){var bufIndex=Math.floor(this.length/8);this.buffer.length<=bufIndex&&this.buffer.push(0);bit&&(this.buffer[bufIndex]|=(0x80>>>(this.length%8)));this.length++};
  var QRMode={MODE_8BIT_BYTE:4};
  var QRErrorCorrectLevel={L:1,M:0,Q:3,H:2};
  function QRCodeModel(typeNumber,errorCorrectLevel){this.typeNumber=typeNumber;this.errorCorrectLevel=errorCorrectLevel;this.modules=null;this.moduleCount=0;this.dataList=[]}
  QRCodeModel.prototype={addData:function(data){this.dataList.push(new QR8bitByte(data))},isDark:function(r,c){return this.modules[r][c]},getModuleCount:function(){return this.moduleCount},
    make:function(){if(this.typeNumber<1){for(var t=1;t<10;t++){var cap=capacity(t);var bb=new BitBuffer;for(var i=0;i<this.dataList.length;i++)this.dataList[i].write(bb);if(bb.length/8<=cap){this.typeNumber=t;break}}}
      this.moduleCount=this.typeNumber*4+17;this.modules=Array.from({length:this.moduleCount},()=>Array(this.moduleCount).fill(null));
      placePatterns(this);var data=createData(this,this.errorCorrectLevel);mapData(this,data);
    }};
  function capacity(type){var base=[17,32,53,78,106,134,154,192,230];return base[type-1]||230}
  function placePatterns(qr){var n=qr.moduleCount;function box(r,c){for(var dr=-1;dr<=7;dr++)for(var dc=-1;dc<=7;dc++){var rr=r+dr,cc=c+dc;if(rr<0||rr>=n||cc<0||cc>=n)continue;var on=(dr>=0&&dr<=6&&(dc==0||dc==6))||(dc>=0&&dc<=6&&(dr==0||dr==6))||(dr>=2&&dr<=4&&dc>=2&&dc<=4);qr.modules[rr][cc]=on}}
    box(0,0);box(n-7,0);box(0,n-7);for(var i=8;i<n-8;i++){qr.modules[6][i]=(i%2==0);qr.modules[i][6]=(i%2==0)} }
  function createData(qr,ec){var bb=new BitBuffer;for(var i=0;i<qr.dataList.length;i++){bb.put(QRMode.MODE_8BIT_BYTE,4);bb.put(qr.dataList[i].getLength(),8);qr.dataList[i].write(bb)}
    var cap=capacity(qr.typeNumber)*8;if(bb.length>cap)bb.length=cap;while(bb.length%8!=0)bb.put(0,1);var bytes=bb.buffer;while(bytes.length<cap/8)bytes.push(0);return bytes}
  function mapData(qr,data){var n=qr.moduleCount,inc=-1,row=n-1,bit=0,byteIndex=0;for(var col=n-1;col>0;col-=2){if(col==6)col--;for(;;){for(var c=0;c<2;c++){var cc=col-c;if(qr.modules[row][cc]===null){var dark=false;if(byteIndex<data.length){dark=((data[byteIndex]>>>(7-bit))&1)==1;bit++;if(bit==8){byteIndex++;bit=0}} qr.modules[row][cc]=dark}}
      row+=inc;if(row<0||row>=n){row-=inc;inc=-inc;break}}}
  function drawCanvas(el,qr,size){var n=qr.getModuleCount();var scale=Math.max(3,Math.floor((size||256)/n));var c=document.createElement('canvas');c.width=n*scale;c.height=n*scale;var ctx=c.getContext('2d');ctx.fillStyle='#fff';ctx.fillRect(0,0,c.width,c.height);ctx.fillStyle='#000';for(var r=0;r<n;r++)for(var col=0;col<n;col++)if(qr.isDark(r,col))ctx.fillRect(col*scale,r*scale,scale,scale);el.innerHTML='';el.appendChild(c)}
  window.__qrRender=function(el,text,size){try{var qr=new QRCodeModel(0,QRErrorCorrectLevel.M);qr.addData(text);qr.make();drawCanvas(el,qr,size);return true}catch(e){el.innerHTML='<small style="color:#ff8080">QR error: '+e.message+'</small>';return false}}
})();
</script>
<script>
(function(){
  const qrEl = document.getElementById('qr');
  const linkEl = document.getElementById('link');
  const diag = document.getElementById('diag');
  const intervalEl = document.getElementById('interval');
  const btnTest = document.getElementById('btnTest');
  const btnStart= document.getElementById('btnStart');
  const btnStop = document.getElementById('btnStop');
  let timer=null, seconds=0, ms=10000, lastToken='';

  function log(m){ diag.textContent += (m+'
'); }
  function token(len=16){ const a=new Uint8Array(len); crypto.getRandomValues(a); return Array.from(a).map(x=>('0'+x.toString(16)).slice(-2)).join(''); }
  function makeURL(tok){ const u=new URL(location.href); u.search=''; u.searchParams.set('mode','student'); u.searchParams.set('session','DEBUG-SESSION'); u.searchParams.set('token',tok); return u.toString(); }
  function render(text){ const ok = window.__qrRender(qrEl,text,256); linkEl.textContent = text; log(ok? '[render] ok':'[render] failed'); }

  btnTest.onclick = ()=>{ const demo='https://example.com/?demo='+Date.now(); render(demo); };
  btnStart.onclick= ()=>{
    const sec = Math.max(3, parseInt(intervalEl.value||'10',10)); ms = sec*1000; seconds=1; rotate();
    if(timer) clearInterval(timer); timer=setInterval(()=>{seconds--; if(seconds<=0) rotate();},1000);
    log('[start] rotation '+sec+'s');
  };
  btnStop.onclick = ()=>{ if(timer) clearInterval(timer); timer=null; log('[stop]'); };

  function rotate(){ lastToken = token(16); const url=makeURL(lastToken); render(url); seconds = Math.max(2, Math.floor(ms/1000)); }
})();
</script>
</body>
</html>
