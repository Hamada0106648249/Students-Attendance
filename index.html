<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù†Ø¸Ø§Ù… Ø­Ø¶ÙˆØ± Ø¹Ø¨Ø± QR â€” Ù…Ø­Ø¯Ø« ÙƒÙ„ 10 Ø«ÙˆØ§Ù†Ù</title>
  <link rel="icon" href="data:," />
  <style>
    :root { --pri:#0a7cff; --bg:#0b1020; --card:#121a2c; --muted:#9fb3c8; --ok:#19c37d; --warn:#ffb020; --bad:#ff5454; }
    html,body{margin:0;padding:0;background:var(--bg);color:white;font-family:system-ui,Segoe UI,Arial,"Noto Kufi Arabic",sans-serif}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    h1{font-weight:700;margin:0 0 10px;font-size:clamp(20px,4vw,30px)}
    .sub{color:var(--muted);margin-bottom:18px}
    .row{display:grid;grid-template-columns:1.3fr 1fr;gap:20px}
    .card{background:var(--card);border:1px solid #1c2742;border-radius:16px;padding:16px}
    label{display:block;margin:10px 0 6px;color:#cfe2ff}
    input,select,button,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #25406b;background:#0c1426;color:white}
    input::placeholder{color:#6f86a3}
    button{cursor:pointer;background:linear-gradient(180deg,#0f7bff,#0659c7);border:none}
    button.secondary{background:#17243e}
    button.danger{background:linear-gradient(180deg,#ff6767,#d63a3a)}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .qrBox{display:grid;place-items:center;min-height:280px;border:1px dashed #2a3b60;border-radius:14px}
    .muted{color:#9fb3c8;font-size:13px}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;margin-inline-start:6px;background:#0f1a32;border:1px solid #22345a}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #1f2d4b;text-align:right}
    tr:hover{background:#111a2f}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:20px}
    .hide{display:none}
    .ok{color:var(--ok)}.bad{color:var(--bad)}.warn{color:var(--warn)}
    .footer{margin-top:30px;color:#88a0bd;font-size:12px}
    .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .left{direction:ltr;text-align:left}
    .pill{background:#0a6ad6;padding:4px 10px;border-radius:999px;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø¨Ø§Ù„Ù€ QR (Ù…ØªØ¬Ø¯Ø¯ ÙƒÙ„ 10 Ø«ÙˆØ§Ù†Ù)</h1>
    <div class="sub">ØµÙØ­Ø© ÙˆØ§Ø­Ø¯Ø© ØªØ¹Ù…Ù„ Ø¹Ù„Ù‰ GitHub Pages + Firebase. ØªØ¹Ø±Ø¶ QR Ù…ØªØºÙŠØ±Ù‹Ø§ ÙƒÙ„ 10 Ø«ÙˆØ§Ù†ÙØŒ ÙˆÙŠÙØ¨Ø·ÙÙ„ Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§. ÙŠØ¯Ø®ÙÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ø³Ù…Ù‡ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©ØŒ ÙˆØªØ³ØªØ·ÙŠØ¹ ØªØµØ¯ÙŠØ± Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø¥Ù„Ù‰ Excel.</div>

    <!-- Tabs -->
    <div class="flex" style="margin-bottom:12px">
      <button id="tabInstructor" class="pill">ÙˆØ¶Ø¹ Ø§Ù„Ù…ÙØ­Ø§Ø¶Ø±</button>
      <button id="tabStudent" class="pill" style="background:#1f2d4b">ÙˆØ¶Ø¹ Ø§Ù„Ø·Ø§Ù„Ø¨</button>
      <span class="badge">Bioinformatika â€” Dr. Ahmed M. Sayed Lab</span>
    </div>

    <!-- Instructor Console -->
    <section id="instructor" class="card">
      <div class="row">
        <div>
          <div class="grid2">
            <div>
              <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù‚Ø±Ø±</label>
              <input id="course" placeholder="Ù…Ø«Ø§Ù„: ÙÙŠØ³ÙŠÙˆÙ„ÙˆØ¬ÙŠØ§ â€” Ø§Ù„ÙØ±Ù‚Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©" />
            </div>
            <div>
              <label>Ø±Ù‚Ù…/Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
              <input id="lecture" placeholder="Ù…Ø«Ø§Ù„: Lec 05 â€” Ø§Ù„ØºØ¯Ø¯ Ø§Ù„ÙƒØ¸Ø±ÙŠØ©" />
            </div>
          </div>

          <div class="grid2" style="margin-top:12px">
            <div>
              <label>Ø²Ù…Ù† ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ù…Ø² (Ø«ÙˆØ§Ù†Ù)</label>
              <input id="interval" type="number" min="5" step="5" value="10" />
            </div>
            <div>
              <label>Ø¬Ù„Ø³Ø© Ø§Ù„Ø­Ø¶ÙˆØ±</label>
              <input id="sessionId" placeholder="Ø³ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø¡" disabled />
            </div>
          </div>

          <div class="grid2" style="margin-top:12px">
            <button id="btnStart">Ø¨Ø¯Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø© + ØªØ´ØºÙŠÙ„ QR Ø§Ù„Ù…ØªØ¬Ø¯Ø¯</button>
            <button id="btnStop" class="danger">Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¬Ù„Ø³Ø©</button>
          </div>

          <div class="grid2" style="margin-top:12px">
            <button id="btnExport" class="secondary">ØªØµØ¯ÙŠØ± XLSX</button>
            <button id="btnClear" class="secondary">ØªÙØ±ÙŠØº Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ù…Ø­Ù„ÙŠÙ‹Ø§)</button>
          </div>

          <div id="status" class="muted" style="margin-top:8px"></div>
          <div class="muted" style="margin-top:6px">ØªÙ„Ù…ÙŠØ­: Ø§ÙØªØ­ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ø¹Ù„Ù‰ Ø´Ø§Ø´Ø© Ø§Ù„Ø¹Ø±Ø¶ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¹Ø©ØŒ Ù„ÙŠÙ‚ÙˆÙ… Ø§Ù„Ø·Ù„Ø¨Ø© Ø¨Ù…Ø³Ø­ Ø§Ù„Ù€ QR Ø¨ÙƒØ§Ù…ÙŠØ±Ø§ØªÙ‡Ù….</div>
        </div>
        <div>
          <label>QR Ø§Ù„Ø­Ø§Ù„ÙŠ (ÙŠØ¨Ø·Ù„ Ù…Ø§ Ù‚Ø¨Ù„Ù‡)</label>
          <div id="qr" class="qrBox"><div id="qrTarget"></div></div>
          <div class="muted left" id="qrLink" style="margin-top:8px;word-break:break-all"></div>
          <div class="muted" id="countdown" style="margin-top:6px"></div>
        </div>
      </div>
    </section>

    <!-- Student Check-in -->
    <section id="student" class="card hide">
      <label>Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙƒÙ…Ø§ Ø³ÙŠØ¸Ù‡Ø± ÙÙŠ ÙƒØ´Ù Ø§Ù„Ø­Ø¶ÙˆØ±</label>
      <input id="studentName" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ Ø§Ù„Ø³ÙŠØ¯ ÙØ±Ø¬" />
      <div class="grid2" style="margin-top:12px">
        <button id="btnSubmit">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø¢Ù†</button>
        <button id="btnMyReceipt" class="secondary">ØªØ­Ù…ÙŠÙ„ Ø¥ÙŠØµØ§Ù„ ØµØºÙŠØ± (PNG)</button>
      </div>
      <div class="muted" id="studentMsg" style="margin-top:8px"></div>
    </section>

    <!-- Live Table -->
    <section class="card" style="margin-top:16px">
      <h3 style="margin-top:0">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¶ÙˆØ± (Ù„Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©)</h3>
      <div style="overflow:auto">
        <table id="tbl">
          <thead><tr><th>#</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª</th><th>Ø§Ù„Ø¬Ù„Ø³Ø©</th><th>Ø§Ù„Ù…Ø¹Ø±Ù‘Ù</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <div class="footer">Â© Bioinformatika â€” Dr. Ahmed M. Sayed Lab. ÙŠØ¹Ù…Ù„ Ø¯ÙˆÙ† Ø®Ø§Ø¯Ù… (Static) Ù…Ø¹ Firebase Firestore ÙˆSheetJS ÙˆQRCode.js. 
      <span class="badge">Ù†ØµÙŠØ­Ø© Ø£Ù…Ù†ÙŠØ©: ÙØ¹Ù‘Ù„ Firebase Auth ÙˆØ§ÙƒØªØ¨ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ ÙƒÙ…Ø§ Ø¨Ø§Ù„Ø£Ø³ÙÙ„.</span>
    </div>
  </div>

  <!-- ===== Libraries (CDN) ===== -->
  <!-- Firebase v10 compat CDN (Ø³Ù‡Ù„ Ù„Ù…Ù„Ù ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ GitHub Pages) -->
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
  <!-- QRCode.js -->
  <script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>
  <!-- SheetJS (XLSX) -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <script>
    /***********************
     * 1) Ø¥Ø¹Ø¯Ø§Ø¯ Firebase   *
     ***********************/
    // TODO: Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ù‚ÙŠÙ… Ø£Ø¯Ù†Ø§Ù‡ Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ Ù…Ù† Firebase Console
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Ù…Ø±Ø§Ø¬Ø¹ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    const tokenDocRef = db.doc('meta/currentToken');       // ÙŠØ­Ù…Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø­Ø§Ù„ÙŠ + sessionId
    const attendeesCol = db.collection('attendances');     // Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ±

    /*****************************************
     * 2) ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±/Ø§Ù„Ø·Ø§Ù„Ø¨) *
     *****************************************/
    const qs = new URLSearchParams(location.search);
    const modeFromURL = qs.get('mode');  // 'student' Ø¥Ø°Ø§ Ø¹Ø¨Ø± QR

    const secInstructor = document.getElementById('instructor');
    const secStudent    = document.getElementById('student');
    const tabInstr = document.getElementById('tabInstructor');
    const tabStud  = document.getElementById('tabStudent');

    function showInstructor(){ secInstructor.classList.remove('hide'); secStudent.classList.add('hide'); tabInstr.style.background='#0a6ad6'; tabStud.style.background='#1f2d4b'; }
    function showStudent(){ secStudent.classList.remove('hide'); secInstructor.classList.add('hide'); tabStud.style.background='#0a6ad6'; tabInstr.style.background='#1f2d4b'; }

    tabInstr.onclick = showInstructor;
    tabStud.onclick  = showStudent;

    if(modeFromURL === 'student'){ showStudent(); } else { showInstructor(); }

    /***********************
     * 3) Ù…ØµØ§Ø¯Ù‚Ø© Ø¨Ø³ÙŠØ·Ø©     *
     ***********************/
    // Ø§Ù„Ø·Ø§Ù„Ø¨: Ø¯Ø®ÙˆÙ„ Ù…Ø¬Ù‡ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
    if(modeFromURL === 'student'){
      auth.signInAnonymously().catch(console.error);
    }

    // Ø§Ù„Ù…Ø­Ø§Ø¶Ø±: ÙŠÙ…ÙƒÙ† Ø§Ù„Ø§ÙƒØªÙØ§Ø¡ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¬Ù‡ÙˆÙ„ Ø£ÙŠØ¶Ù‹Ø§ØŒ
    // Ø£Ùˆ ØªÙØ¹ÙŠÙ„ Email/Password ÙˆØªÙ‚ÙŠÙŠØ¯ Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙÙŠ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø¨Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙØ¯Ø±Ù‘Ø³.

    /********************************
     * 4) Ø£Ø¯ÙˆØ§Øª Ø¹Ø§Ù…Ø© / Ù…ÙˆÙ„Ø¯ Ø§Ù„Ø±Ù…ÙˆØ²  *
     ********************************/
    const statusEl   = document.getElementById('status');
    const qrContainer= document.getElementById('qrTarget');
    const qrBox      = document.getElementById('qr');
    const qrLinkEl   = document.getElementById('qrLink');
    const countdownEl= document.getElementById('countdown');

    const courseEl   = document.getElementById('course');
    const lectureEl  = document.getElementById('lecture');
    const sessionEl  = document.getElementById('sessionId');
    const intervalEl = document.getElementById('interval');
    const btnStart   = document.getElementById('btnStart');
    const btnStop    = document.getElementById('btnStop');
    const btnExport  = document.getElementById('btnExport');
    const btnClear   = document.getElementById('btnClear');

    const tblBody    = document.querySelector('#tbl tbody');

    let qrobj = null;
    async function loadScript(src){return new Promise((res,rej)=>{const s=document.createElement('script');s.src=src;s.onload=res;s.onerror=()=>rej(new Error('Failed to load '+src));document.head.appendChild(s);});}
async function ensureQRCodeLib(){
  if(window.QRCode) return;
  try{
    await loadScript('https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js');
  }catch(e){
    // Fallback CDN
    await loadScript('https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js');
  }
}
async function ensureQRCode(){
  await ensureQRCodeLib();
  if(!qrobj){ qrobj = new QRCode(qrContainer, {width:256,height:256}); }
}

    function randomToken(len=24){
      const a = new Uint8Array(len);
      crypto.getRandomValues(a);
      return Array.from(a).map(x=>('0'+x.toString(16)).slice(-2)).join('');
    }

    function nowISO(){ return new Date().toISOString(); }

    // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ù…Ø­Ù„ÙŠÙ‹Ø§)
    let current = {
      sessionId: null,
      course: '',
      lecture: '',
      intervalMs: 10000,
      timer: null,
      secondsLeft: 0,
      lastToken: null
    };

    function setStatus(msg, kind=''){
      statusEl.innerHTML = `<span class="${kind}">${msg}</span>`;
    }

    // Ø±Ø¨Ø· Ø­ÙŠ Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¶ÙˆØ± Ø­Ø³Ø¨ sessionId
    let unsubAtt = null;
    function bindTable(sessionId){
      if(unsubAtt){ unsubAtt(); unsubAtt=null; }
      if(!sessionId) { tblBody.innerHTML=''; return; }
      unsubAtt = attendeesCol.where('sessionId','==',sessionId).orderBy('ts','asc').onSnapshot(snap=>{
        const rows=[]; let i=1;
        snap.forEach(doc=>{
          const d=doc.data();
          rows.push(`<tr><td>${i++}</td><td>${escapeHtml(d.name||'')}</td><td>${fmtTs(d.ts)}</td><td>${escapeHtml(d.sessionId)}</td><td>${doc.id}</td></tr>`);
        });
        tblBody.innerHTML = rows.join('');
      });
    }

    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }
    function fmtTs(ts){ if(!ts) return ''; try{ const d=ts.toDate? ts.toDate(): new Date(ts); return d.toLocaleString('ar-EG'); }catch{ return '' } }

    // ØªØ¯ÙˆÙŠØ± Ø§Ù„Ø±Ù…Ø² ÙƒÙ„ N Ø«ÙˆØ§Ù†Ù: ÙŠÙƒØªØ¨ Ù‚ÙŠÙ…Ø© Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ meta/currentToken => ØªÙØ¨Ø·Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
    async function rotateToken(){
      const token = randomToken(16);
      current.lastToken = token;
      const payload = {
        value: token,
        sessionId: current.sessionId,
        course: current.course,
        lecture: current.lecture,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        active: true
      };
      await tokenDocRef.set(payload, {merge:true});

      // ØªÙˆÙ„ÙŠØ¯ Ø±Ø§Ø¨Ø· Ø§Ù„Ø·Ø§Ù„Ø¨ + QR
      const url = new URL(location.href);
      url.search = ''; // Ù†Ø²ÙŠÙ„ Ø£ÙŠ Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø³Ø§Ø¨Ù‚
      url.searchParams.set('mode','student');
      url.searchParams.set('session', current.sessionId);
      url.searchParams.set('token', token);
      ensureQRCode();
      await ensureQRCode();
      if(qrobj.clear) qrobj.clear();
      qrobj.makeCode(url.toString());
      qrLinkEl.textContent = url.toString();

      // Ø¹Ø¯Ù‘ ØªÙ†Ø§Ø²Ù„ÙŠ Ø¨Ø³ÙŠØ·
      current.secondsLeft = Math.max(2, Math.floor(current.intervalMs/1000));
      renderCountdown();
    }

    function renderCountdown(){
      countdownEl.textContent = `Ø³ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø±Ù…Ø² Ø¬Ø¯ÙŠØ¯ Ø¨Ø¹Ø¯ ${current.secondsLeft} Ø«Ø§Ù†ÙŠØ©â€¦`;
    }

    function tick(){
      current.secondsLeft -= 1;
      if(current.secondsLeft <= 0){ rotateToken().catch(console.error); }
      else { renderCountdown(); }
    }

    function startTimer(){
      if(current.timer) clearInterval(current.timer);
      current.timer = setInterval(tick, 1000);
    }

    async function startSession(){
      current.course = (courseEl.value||'').trim();
      current.lecture= (lectureEl.value||'').trim();
      const sec = Math.max(5, parseInt(intervalEl.value||'10',10));
      current.intervalMs = sec*1000;
      current.sessionId = `SES-${new Date().toISOString().replace(/[:.TZ-]/g,'').slice(0,14)}`; // YYYYMMDDhhmmss
      sessionEl.value = current.sessionId;
      setStatus('ØªÙ… Ø¨Ø¯Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©. ÙŠØªÙ… Ø§Ù„Ø¢Ù† ØªØ¯ÙˆÙŠØ± Ø±Ù…Ø² QR ÙƒÙ„ '+sec+' Ø«Ø§Ù†ÙŠØ©.', 'ok');
      bindTable(current.sessionId);
      await rotateToken();
      startTimer();
    }

    async function stopSession(){
      if(current.timer) { clearInterval(current.timer); current.timer=null; }
      await tokenDocRef.set({active:false}, {merge:true});
      setStatus('ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¬Ù„Ø³Ø©. Ù„Ù† ØªÙÙ‚Ø¨Ù„ Ø£ÙŠØ© Ø£ÙƒÙˆØ§Ø¯ Ø¬Ø¯ÙŠØ¯Ø© Ø­ØªÙ‰ ØªØ¨Ø¯Ø£ Ø¬Ù„Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø©.', 'warn');
      countdownEl.textContent = '';
    }

    btnStart.onclick = startSession;
    // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¥Ù† Ù„Ù… ÙŠØ¸Ù‡Ø± QR ÙØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ø§Ø¶Ø± Ø«Ù… Ø§Ø¶ØºØ· "Ø¨Ø¯Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©". Ù„Ø§ ÙŠØ¸Ù‡Ø± QR ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø·Ø§Ù„Ø¨.
    btnStop.onclick  = stopSession;

    // ØªØµØ¯ÙŠØ± XLSX Ù„Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    btnExport.onclick = async () => {
      if(!current.sessionId){ alert('Ø§Ø¨Ø¯Ø£ Ø¬Ù„Ø³Ø© Ø£ÙˆÙ„Ù‹Ø§.'); return; }
      const snap = await attendeesCol.where('sessionId','==',current.sessionId).orderBy('ts','asc').get();
      const rows = [['#','Ø§Ù„Ø§Ø³Ù…','Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª','Ø§Ù„Ø¬Ù„Ø³Ø©','DocID']];
      let i=1; snap.forEach(doc=>{ const d=doc.data(); rows.push([i++, d.name||'', fmtTs(d.ts), d.sessionId||'', doc.id]); });
      const ws = XLSX.utils.aoa_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Attendance');
      const title = (current.course||'Course') + ' â€” ' + (current.lecture||'Lecture') + ' â€” ' + current.sessionId + '.xlsx';
      XLSX.writeFile(wb, title);
    };

    // ØªÙØ±ÙŠØº Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙÙ‚Ø· (Ù„Ø§ ÙŠØ­Ø°Ù Ù…Ù† Firestore)
    btnClear.onclick = ()=>{ tblBody.innerHTML=''; };

    /********************************
     * 5) ÙˆØ¶Ø¹ Ø§Ù„Ø·Ø§Ù„Ø¨: Ø§Ù„ØªØ­Ù‚Ù‚ + Ø¥Ø¯Ø®Ø§Ù„ *
     ********************************/
    const nameEl   = document.getElementById('studentName');
    const btnSub   = document.getElementById('btnSubmit');
    const btnRec   = document.getElementById('btnMyReceipt');
    const msgEl    = document.getElementById('studentMsg');

    async function studentSubmit(){
      const name = (nameEl.value||'').trim();
      if(name.length < 2){ msgEl.innerHTML = '<span class="bad">Ø±Ø¬Ø§Ø¡Ù‹ Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ ÙƒØ§Ù…Ù„Ù‹Ø§ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©.</span>'; return; }

      const token = qs.get('token') || '';
      const sessionId = qs.get('session') || '';
      if(!token || !sessionId){ msgEl.innerHTML = '<span class="bad">Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­ (Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø±Ù…Ø²/Ø¬Ù„Ø³Ø©).</span>'; return; }

      // Ù†Ù‚Ø±Ø£ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ù† Firestore Ù„Ø¶Ù…Ø§Ù† Ø£Ù†Ù‡ Ø§Ù„Ø£Ø­Ø¯Ø«
      const cur = await tokenDocRef.get();
      if(!cur.exists){ msgEl.innerHTML = '<span class="bad">Ù„Ù… ÙŠØªÙ… Ø¨Ø¯Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø© Ø¨Ø¹Ø¯.</span>'; return; }
      const data = cur.data();
      if(!data.active){ msgEl.innerHTML = '<span class="warn">Ø§Ù„Ø¬Ù„Ø³Ø© Ù…ØªÙˆÙ‚ÙØ© Ø­Ø§Ù„ÙŠÙ‹Ø§.</span>'; return; }
      if(data.sessionId !== sessionId){ msgEl.innerHTML = '<span class="bad">Ø¬Ù„Ø³Ø© ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©. Ø§Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ù…Ø­Ø§Ø¶Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ù…Ø².</span>'; return; }
      if(data.value !== token){ msgEl.innerHTML = '<span class="bad">Ù‡Ø°Ø§ Ø§Ù„Ø±Ù…Ø² Ø£ØµØ¨Ø­ Ù‚Ø¯ÙŠÙ…Ù‹Ø§. Ø§Ù…Ø³Ø­ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù‚Ø§Ø¹Ø©.</span>'; return; }

      // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø¶ÙˆØ±
      const rec = { name, sessionId, token, ts: firebase.firestore.FieldValue.serverTimestamp(), ua: navigator.userAgent };
      const ref = await attendeesCol.add(rec);
      msgEl.innerHTML = `<span class="ok">ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±Ùƒ Ø¨Ù†Ø¬Ø§Ø­. Ù…Ø¹Ø±Ù Ø§Ù„Ø³Ø¬Ù„: ${ref.id}</span>`;
      nameEl.value = '';
    }

    btnSub && (btnSub.onclick = studentSubmit);

    // Ø¥ÙŠØµØ§Ù„ Ø¨Ø³ÙŠØ· ÙƒØµÙˆØ±Ø© PNG Ù…Ø­Ù„ÙŠØ© (Ù„Ø§ ÙŠÙØ±ÙØ¹)
    btnRec && (btnRec.onclick = ()=>{
      const name = (nameEl.value||'').trim();
      const sessionId = qs.get('session') || current.sessionId || '';
      const cnv = document.createElement('canvas');
      cnv.width = 800; cnv.height = 300; const ctx = cnv.getContext('2d');
      ctx.fillStyle = '#0b1020'; ctx.fillRect(0,0,cnv.width,cnv.height);
      ctx.fillStyle = '#19c37d'; ctx.font = '28px \\"Noto Kufi Arabic\\", system-ui';
      ctx.fillText('Ø¥ÙŠØµØ§Ù„ Ø­Ø¶ÙˆØ± â€” Attendance Receipt', 20, 50);
      ctx.fillStyle = '#fff'; ctx.font = '26px \\"Noto Kufi Arabic\\", system-ui';
      ctx.fillText('Ø§Ù„Ø§Ø³Ù…: '+(name||'â€”'), 20, 120);
      ctx.fillText('Ø§Ù„Ø¬Ù„Ø³Ø©: '+(sessionId||'â€”'), 20, 160);
      const dt = new Date().toLocaleString('ar-EG');
      ctx.fillText('Ø§Ù„ÙˆÙ‚Øª: '+dt, 20, 200);
      const a = document.createElement('a'); a.download = 'receipt.png'; a.href = cnv.toDataURL(); a.click();
    });

    // ØªÙ†Ø´ÙŠØ· ØªÙ„Ù‚Ø§Ø¦ÙŠ: Ù„Ùˆ ÙØªØ­ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ø§Ù„Ø±Ø§Ø¨Ø·
    if(modeFromURL==='student'){
      const s = qs.get('session'); if(s){ bindTable(s); } // Ø¹Ø±Ø¶ Ù†ÙØ³ Ø§Ù„Ø¬Ù„Ø³Ø© Ø¥Ù† Ø£Ø±Ø¯Øª Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø­ÙŠÙ‹Ø§
    }

    // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ø§Ù„Ø±Ù…Ø² (Ù„Ù„Ù…ÙØ­Ø§Ø¶Ø± ÙÙ‚Ø·)
    tokenDocRef.onSnapshot(doc=>{
      const d=doc.data();
      if(!d) return;
      if(d.sessionId && d.sessionId!==current.sessionId){ sessionEl.value = d.sessionId; current.sessionId = d.sessionId; bindTable(d.sessionId); }
    });
  </script>

  <!--
  ===============================
  ğŸ” Ø§Ù‚ØªØ±Ø§Ø­ Ù‚ÙˆØ§Ø¹Ø¯ Ø£Ù…Ø§Ù† Firestore
  Ø§Ù†Ø³Ø® Ù‡Ø°Ù‡ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ (Console â–º Firestore Database â–º Rules)
  - ØªØ³Ù…Ø­ Ø¨Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù„Ø¬Ù…ÙŠØ¹.
  - ØªØªÙŠØ­ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø±Ù…Ø²/Ø¬Ù„Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ù…Ø­Ø§Ø¶Ø± ÙÙ‚Ø· (Ø¨Ø¯Ù‘Ù„ TEACHER_UID).
  - ØªØªÙŠØ­ Ù„Ù„Ø·Ù„Ø§Ø¨ Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø­Ø¶ÙˆØ± ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† token Ø§Ù„Ø­Ø§Ù„ÙŠ ÙŠØ·Ø§Ø¨Ù‚ meta/currentToken.
  ===============================

  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      match /meta/currentToken {
        allow read: if true;  // ÙŠØ³ØªØ·ÙŠØ¹ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø±Ù…Ø²
        allow write: if request.auth != null && request.auth.uid in ['TEACHER_UID'];
      }

      match /attendances/{doc} {
        allow read: if request.auth != null; // Ø£Ùˆ true Ø¥Ù† Ø±ØºØ¨Øª
        allow create: if (
          // Ø§Ø³Ù… Ø¹Ø±Ø¨ÙŠ Ù…Ø¹ Ù…Ø³Ø§ÙØ§Øª (Ø­Ø¯ Ø£Ù‚ØµÙ‰ 80)
          request.resource.data.name is string && request.resource.data.name.size() > 1 && request.resource.data.name.size() <= 80 &&

          // ÙˆØ¬ÙˆØ¯ sessionId Ùˆ token ÙƒØ³Ù„Ø§Ø³Ù„ Ù‚ØµÙŠØ±Ø©
          request.resource.data.sessionId is string && request.resource.data.sessionId.size() > 3 &&
          request.resource.data.token is string && request.resource.data.token.size() > 10 &&

          // Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆØ§Ù„Ø¬Ù„Ù€Ø³Ø©
          request.resource.data.token == get(/databases/$(database)/documents/meta/currentToken).data.value &&
          request.resource.data.sessionId == get(/databases/$(database)/documents/meta/currentToken).data.sessionId &&

          // Ø®ØªÙ… Ø²Ù…Ù†ÙŠ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…
          request.time >= timestamp.date(2020,1,1)
        );
      }
    }
  }

  Ù…Ù„Ø§Ø­Ø¸Ø©:
  - Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø§Ù†Ø¶Ø¨Ø§Ø· ÙŠÙ…ÙƒÙ†Ùƒ ØªÙØ¹ÙŠÙ„ Anonymous Auth Ù„Ù„Ø·Ù„Ø§Ø¨ (Ù„ÙˆØ¶Ø¹ student) ÙˆØªÙØ¹ÙŠÙ„ Email/Password Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø­Ø§Ø¶Ø± Ø«Ù… ÙˆØ¶Ø¹ UID ÙÙŠ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø£Ø¹Ù„Ø§Ù‡.
  - ÙƒÙ„ ØªØ¯ÙˆÙŠØ± Ù„Ù„Ø±Ù…Ø² ÙŠÙƒØªØ¨ Ù‚ÙŠÙ…Ø© Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ meta/currentTokenØŒ ÙˆØ¨Ø°Ù„Ùƒ ÙŠÙØ±ÙØ¶ Ø£ÙŠ Ø¥Ø±Ø³Ø§Ù„ ÙŠØ³ØªØ®Ø¯Ù… Ø±Ù…Ø²Ù‹Ø§ Ù‚Ø¯ÙŠÙ…Ù‹Ø§.
  - ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø²Ù…Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù…Ù† ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø­Ø§Ø¶Ø±.
  -->
</body>
</html>
